<!DOCTYPE html>
<html>
<head>
    <title>Comprehensive Copy CSS Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .font-card {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            cursor: pointer;
            border-radius: 8px;
        }
        .font-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #4285F4;
        }
        .btn {
            padding: 8px 16px;
            margin-right: 10px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
        }
        .btn-primary {
            background-color: #4285F4;
            color: white;
        }
        .btn-secondary {
            background-color: #f1f1f1;
            color: #333;
        }
        #preview-text {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            width: 100%;
            margin: 20px 0;
            font-size: 16px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #e8f5e9;
            color: #2E7D32;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
        .info {
            background-color: #e8f0fe;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <h1>üß™ Comprehensive Copy CSS Fix Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Event Propagation Fix</h2>
        <p>Click on the font card to change preview text font.</p>
        <p>Click on "Copy CSS" button - it should NOT change the preview text font.</p>
        <p>Click on "View on Google" button - it should also NOT change the preview text font.</p>
        
        <input type="text" id="preview-text" value="Preview text - click should change this font">
        
        <div class="font-card" data-font-name="Test Font" data-font-category="sans-serif">
            <div class="font-name">Test Font</div>
            <div class="font-preview">This is a preview of Test Font</div>
            <div class="font-actions">
                <button class="btn btn-primary" onclick="copyCSS('Test Font', 'sans-serif', event)">Copy CSS</button>
                <button class="btn btn-secondary" onclick="viewOnGoogle('Test Font')">View on Google</button>
            </div>
        </div>
        
        <div id="test1-result" class="test-result info">Test not run yet</div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Clipboard API Fallback</h2>
        <p>This tests the clipboard copy functionality with fallback methods.</p>
        <button class="btn btn-primary" onclick="testClipboardAPI()">Test Clipboard API</button>
        <button class="btn btn-secondary" onclick="testFallbackCopy()">Test Fallback Method</button>
        
        <div id="test2-result" class="test-result info">Test not run yet</div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Modal Display Fallback</h2>
        <p>This tests the modal display when clipboard copy fails completely.</p>
        <button class="btn btn-primary" onclick="testModalFallback()">Test Modal Fallback</button>
        
        <div id="test3-result" class="test-result info">Test not run yet</div>
    </div>
    
    <div class="test-section">
        <h2>Test Results Summary</h2>
        <div id="summary-result" class="test-result info">No tests run yet</div>
    </div>
    
    <script>
        let previewText = "Preview text - click should change this font";
        let testResults = [];
        
        function copyCSS(fontName, category, event) {
            // Prevent event bubbling if event is passed
            if (event) {
                event.stopPropagation();
                console.log('‚úÖ Event propagation stopped for Copy CSS button');
                updateTestResult('test1-result', '‚úÖ Copy CSS button click did NOT change preview font (event propagation working)', 'success');
            }
            
            console.log('Copy CSS called for:', fontName);
            
            // Simulate the clipboard copy process
            const testCSS = `/* Test CSS for ${fontName} */
.test-font {
    font-family: '${fontName}', ${category};
}`;
            
            tryCopyToClipboard(testCSS, fontName);
        }
        
        function viewOnGoogle(fontName) {
            console.log('View on Google called for:', fontName);
            updateTestResult('test1-result', '‚úÖ View on Google button click did NOT change preview font', 'success');
        }
        
        function changePreviewFont(fontName, fontCategory) {
            console.log('Preview font changed to:', fontName);
            const previewTextElement = document.getElementById('preview-text');
            if (previewTextElement) {
                previewTextElement.value = '‚ùå Font changed to: ' + fontName + ' (this should NOT happen when clicking buttons!)';
                updateTestResult('test1-result', '‚ùå Font card click changed preview font to: ' + fontName, 'error');
            }
        }
        
        // Robust clipboard copy function with fallback for unsupported environments
        function tryCopyToClipboard(text, fontName, isFallback = false) {
            console.log('Trying to copy to clipboard...');
            
            // Check if clipboard API is available
            if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                console.log('Clipboard API available');
                navigator.clipboard.writeText(text).then(() => {
                    console.log('Clipboard API success');
                    updateTestResult('test2-result', '‚úÖ Clipboard API worked successfully', 'success');
                    if (isFallback) {
                        alert(`‚ö†Ô∏è Copied fallback CSS for ${fontName}.`);
                    } else {
                        alert(`‚úÖ CSS for ${fontName} copied to clipboard!`);
                    }
                }).catch(err => {
                    console.error('Clipboard API failed:', err);
                    updateTestResult('test2-result', '‚ö†Ô∏è Clipboard API failed, trying fallback: ' + err.message, 'error');
                    // Fallback to textarea method
                    copyToClipboardFallback(text, fontName, isFallback);
                });
            } else {
                console.log('Clipboard API not available');
                updateTestResult('test2-result', '‚ö†Ô∏è Clipboard API not available, using fallback', 'error');
                // Clipboard API not available, use fallback
                copyToClipboardFallback(text, fontName, isFallback);
            }
        }
        
        // Fallback clipboard copy method using textarea
        function copyToClipboardFallback(text, fontName, isFallback = false) {
            try {
                console.log('Using fallback copy method...');
                // Create a temporary textarea element
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                
                // Try to execute copy command
                const success = document.execCommand('copy');
                document.body.removeChild(textarea);
                
                if (success) {
                    console.log('Fallback copy successful');
                    updateTestResult('test2-result', '‚úÖ Fallback copy method worked', 'success');
                    if (isFallback) {
                        alert(`‚úÖ Copied fallback CSS for ${fontName} to clipboard (using fallback method).`);
                    } else {
                        alert(`‚úÖ CSS for ${fontName} copied to clipboard (using fallback method)!`);
                    }
                } else {
                    console.log('Fallback copy failed');
                    updateTestResult('test2-result', '‚ùå Fallback copy failed, showing modal', 'error');
                    // If copy command fails, show the CSS in a modal
                    showCSSInModal(text, fontName, isFallback);
                }
            } catch (err) {
                console.error('Fallback copy method failed:', err);
                updateTestResult('test2-result', '‚ùå Fallback copy method failed: ' + err.message, 'error');
                // Show CSS in modal as last resort
                showCSSInModal(text, fontName, isFallback);
            }
        }
        
        // Show CSS in a modal dialog for manual copying
        function showCSSInModal(css, fontName, isFallback = false) {
            console.log('Showing CSS in modal...');
            updateTestResult('test3-result', '‚úÖ Modal fallback displayed successfully', 'success');
            
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            modal.style.zIndex = '10000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.padding = '20px';
            modal.style.boxSizing = 'border-box';
            
            // Create modal content
            const content = document.createElement('div');
            content.style.backgroundColor = 'white';
            content.style.padding = '20px';
            content.style.borderRadius = '8px';
            content.style.maxWidth = '800px';
            content.style.width = '100%';
            content.style.maxHeight = '80vh';
            content.style.overflow = 'auto';
            content.style.position = 'relative';
            
            // Create close button
            const closeButton = document.createElement('button');
            closeButton.textContent = '√ó';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '10px';
            closeButton.style.right = '10px';
            closeButton.style.background = 'none';
            closeButton.style.border = 'none';
            closeButton.style.fontSize = '24px';
            closeButton.style.cursor = 'pointer';
            closeButton.style.color = '#666';
            closeButton.onclick = function() {
                document.body.removeChild(modal);
            };
            
            // Create title
            const title = document.createElement('h3');
            title.textContent = `CSS for ${fontName}`;
            title.style.marginTop = '0';
            title.style.color = '#4285F4';
            
            // Create subtitle
            const subtitle = document.createElement('p');
            subtitle.textContent = 'Could not copy automatically. Please manually copy the CSS below:';
            subtitle.style.color = '#666';
            subtitle.style.marginBottom = '15px';
            
            // Create CSS textarea
            const cssTextarea = document.createElement('textarea');
            cssTextarea.value = css;
            cssTextarea.style.width = '100%';
            cssTextarea.style.height = '300px';
            cssTextarea.style.fontFamily = 'monospace';
            cssTextarea.style.fontSize = '14px';
            cssTextarea.style.padding = '10px';
            cssTextarea.style.border = '1px solid #ddd';
            cssTextarea.style.borderRadius = '4px';
            cssTextarea.style.resize = 'vertical';
            cssTextarea.style.marginBottom = '15px';
            
            // Create copy instructions
            const instructions = document.createElement('p');
            instructions.innerHTML = '<strong>To use this CSS:</strong><br>' +
                '1. Select all text above (Ctrl+A or Cmd+A)<br>' +
                '2. Copy it (Ctrl+C or Cmd+C)<br>' +
                '3. Paste it into your stylesheet<br>' +
                '4. Use the provided class names in your HTML';
            instructions.style.color = '#666';
            instructions.style.fontSize = '14px';
            
            // Assemble modal
            content.appendChild(closeButton);
            content.appendChild(title);
            content.appendChild(subtitle);
            content.appendChild(cssTextarea);
            content.appendChild(instructions);
            modal.appendChild(content);
            
            // Add modal to body
            document.body.appendChild(modal);
            
            // Auto-select CSS text
            cssTextarea.select();
        }
        
        function testClipboardAPI() {
            const testText = '/* Test CSS Content */\n.test-class { color: red; }';
            tryCopyToClipboard(testText, 'Test Font');
        }
        
        function testFallbackCopy() {
            // Force the fallback by simulating clipboard API failure
            const originalClipboard = navigator.clipboard;
            navigator.clipboard = null;
            
            const testText = '/* Test CSS Content */\n.test-class { color: blue; }';
            tryCopyToClipboard(testText, 'Test Font');
            
            // Restore clipboard
            navigator.clipboard = originalClipboard;
        }
        
        function testModalFallback() {
            const testCSS = '/* Test Modal CSS */\n.modal-test { background: yellow; }';
            showCSSInModal(testCSS, 'Modal Test Font');
        }
        
        function updateTestResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = 'test-result ' + type;
            }
            
            // Update summary
            testResults.push({elementId, message, type});
            updateSummary();
        }
        
        function updateSummary() {
            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            const totalCount = testResults.length;
            
            const summaryElement = document.getElementById('summary-result');
            if (summaryElement) {
                if (totalCount === 0) {
                    summaryElement.textContent = 'No tests run yet';
                    summaryElement.className = 'test-result info';
                } else {
                    let message = `Tests completed: ${successCount} passed, ${errorCount} failed`;
                    if (errorCount === 0) {
                        message += ' - All tests passed! ‚úÖ';
                        summaryElement.className = 'test-result success';
                    } else {
                        message += ' - Some tests failed ‚ö†Ô∏è';
                        summaryElement.className = 'test-result error';
                    }
                    summaryElement.textContent = message;
                }
            }
        }
        
        // Font card clicks - change preview text font
        document.addEventListener('click', (e) => {
            const fontCard = e.target.closest('.font-card');
            if (fontCard) {
                // Don't change preview font if clicking on Copy CSS button or View on Google button
                const copyCSSButton = e.target.closest('.btn-primary');
                const viewGoogleButton = e.target.closest('.btn-secondary');
                
                console.log('Font card clicked. Copy CSS button:', copyCSSButton, 'View Google button:', viewGoogleButton);
                
                if (!copyCSSButton && !viewGoogleButton) {
                    const fontName = fontCard.dataset.fontName;
                    const fontCategory = fontCard.dataset.fontCategory;
                    changePreviewFont(fontName, fontCategory);
                } else {
                    console.log('Button click detected, not changing preview font');
                }
            }
        });
    </script>
</body>
</html>